---
# tasks file for docker
- name: Install docker repo
  command: 'dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo'
  become: yes
  become_user: root
  tags: docker

- name: Uninstall any podman-docker
  dnf:
    name: docker
    state: absent
  tags: docker

- name: Install docker
  dnf:
    name: ['docker-ce', 'docker-ce-cli', 'containerd.io']
    state: latest
  tags: docker

- name: Enable and start docker
  systemd:
    name: docker
    state: started
    enabled: yes 
  tags: docker

- name: Install portainer agent
  docker_swarm_service:
    name: portainer_agent
    image: portainer/agent
    mode: global
    restart_policy: any
    publish:
      - mode: host
        target_port: 9513
        published_port: 9001
    mounts:
      - source: /var/run/docker.sock
        target: /var/run/docker.sock
        type: bind
      - source: /var/lib/docker/volumes
        target: /var/lib/docker/volumes
        type: bind
  tags: docker